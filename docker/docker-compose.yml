# Sirius - AI DevOps Agent - Docker Compose

version: '3.8'

services:
  # Main Sirius Agent
  sirius:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: sirius
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      # Configuration (read-only)
      - ../config:/app/config:ro
      # Logs
      - sirius-logs:/var/log/sirius
      # SSH keys for server access (read-only)
      - ${HOME}/.ssh:/home/agent/.ssh:ro
    environment:
      # NVIDIA NIM API
      - NVIDIA_API_KEY=${NVIDIA_API_KEY}
      # Slack integration
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      # Config path
      - SIRIUS_CONFIG_PATH=/app/config/config.yaml
      # Environment
      - SIRIUS_NVIDIA_ENVIRONMENT=${NVIDIA_ENVIRONMENT:-development}
      # SSH Configuration
      - SSH_KEY_PATH=${SSH_KEY_PATH:-/home/agent/.ssh/id_rsa}
      - SSH_USERNAME=${SSH_USERNAME:-ec2-user}
      - SSH_KNOWN_HOSTS=${SSH_KNOWN_HOSTS:-/home/agent/.ssh/known_hosts}
    # Hostname resolution for monitored servers
    extra_hosts:
      - "dev-app-3:10.2.4.5"
      - "dev-app-6:10.2.6.96"
      - "qa-app-9:10.1.11.193"
      - "qa-app-3:10.1.12.180"
      - "qa-maxwell:10.1.13.131"
      - "qa-pmongo-m1:10.1.12.100"
      - "ops-graylog:10.3.35.50"
      - "dev-mongo-test:10.2.7.208"
      - "dev-ph-mongo:10.2.7.57"
      - "dev-log:10.2.8.146"
      - "dev-payroll-mongo:10.2.8.78"
      - "ops-jenkins-slave-automation:10.3.75.25"
    networks:
      - sirius-net
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Redis for state management and deduplication
  redis:
    image: redis:7-alpine
    container_name: sirius-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    networks:
      - sirius-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Optional: Self-hosted NVIDIA NIM (production)
  # Uncomment to enable GPU-accelerated inference
  # nvidia-nim:
  #   image: nvcr.io/nim/meta/llama-3.1-70b-instruct:latest
  #   container_name: nvidia-nim
  #   runtime: nvidia
  #   environment:
  #     - NGC_API_KEY=${NGC_API_KEY}
  #   ports:
  #     - "8000:8000"
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: 2
  #             capabilities: [gpu]
  #   networks:
  #     - sirius-net

networks:
  sirius-net:
    driver: bridge

volumes:
  sirius-logs:
  redis-data:
